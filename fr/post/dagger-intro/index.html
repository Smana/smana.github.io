<!doctype html><html lang=fr data-figures class=page><head><title>`Dagger`: la pièce manquante de l'expérience développeur? | Ogenki</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","XXXXXXXXXX")</script><meta property="og:locale" content="fr"><meta property="og:locale:alternate" content="en"><meta property="og:type" content="article"><meta name=description content="Découverte de Dagger pour améliorer l'automatisation et simplifier les pipelines de développement. Self-Hosted Github Actions et EKS pour un partage efficace du …"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@smana.dev"><meta name=twitter:title content="`Dagger`: la pièce manquante de l'expérience développeur?"><meta name=twitter:image content="https://blog.ogenki.io/fr/post/dagger-intro/thumbnail.png"><meta property="og:url" content="https://blog.ogenki.io/fr/post/dagger-intro/"><meta property="og:title" content="`Dagger`: la pièce manquante de l'expérience développeur?"><meta property="og:description" content="Découverte de Dagger pour améliorer l'automatisation et simplifier les pipelines de développement. Self-Hosted Github Actions et EKS pour un partage efficace du …"><meta property="og:image" content="https://blog.ogenki.io/fr/post/dagger-intro/thumbnail.png"><meta name=keywords content="devxp"><link rel=apple-touch-icon sizes=180x180 href=https://blog.ogenki.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.ogenki.io/icons/favicon-32x32.png><link rel=manifest href=https://blog.ogenki.io/icons/site.webmanifest><link rel=canonical href=https://blog.ogenki.io/fr/post/dagger-intro/><link rel=preload href=https://blog.ogenki.io/css/styles.a556cef0edd8ecd9821e661f7f201d84cc18d0c6435703889db2949aea0eccb84b7ac9a2bb49093b03f5e7d9ce21c23c705efd6dcbd7e8018afae9a9f32ca095.css integrity="sha512-pVbO8O3Y7NmCHmYffyAdhMwY0MZDVwOInbKUmuoOzLhLesmiu0kJOwP159nOIcI8cF79bcvX6AGK+ump8yyglQ==" as=style crossorigin=anonymous><link rel=preload href=https://blog.ogenki.io/fr/js/bundle.ae629666f8c58d943212e88a5f947766206c1a1a51ff5eaf4ff5a9281342b8ecd6b2ccb43d0136116dac746a8a4d6fa8f57bd22af9acc4b0aa9714608d09e679.js as=script integrity="sha512-rmKWZvjFjZQyEuiKX5R3ZiBsGhpR/16vT/WpKBNCuOzWssy0PQE2EW2sdGqKTW+o9XvSKvmsxLCqlxRgjQnmeQ==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://blog.ogenki.io/css/styles.a556cef0edd8ecd9821e661f7f201d84cc18d0c6435703889db2949aea0eccb84b7ac9a2bb49093b03f5e7d9ce21c23c705efd6dcbd7e8018afae9a9f32ca095.css integrity="sha512-pVbO8O3Y7NmCHmYffyAdhMwY0MZDVwOInbKUmuoOzLhLesmiu0kJOwP159nOIcI8cF79bcvX6AGK+ump8yyglQ==" crossorigin=anonymous></head><body data-code=21 data-lines=false id=documentTop data-lang=fr><header class=nav_header><nav class=nav><a href=https://blog.ogenki.io/fr/ class="nav_brand nav_item" title=Ogenki><img src=https://blog.ogenki.io/logos/logo.png class=logo alt=Ogenki><div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg>
<svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://blog.ogenki.io/fr/ class=nav_item title=Home>Home</a></div><div class=nav_parent><a href=https://blog.ogenki.io/fr/ class=nav_item title=Liens>Liens <img src=https://blog.ogenki.io/icons/caret-icon.svg alt=icon class=nav_icon></a><div class=nav_sub><span class=nav_child></span>
<a href=https://bsky.app/profile/smana.dev class="nav_child nav_item" title=Bluesky>Bluesky</a></div></div><div class=nav_parent><a href=https://blog.ogenki.io/fr/about/ class=nav_item title=Apropos>Apropos</a></div><div class=nav_parent><a href=https://blog.ogenki.io/fr/ class=nav_item title=Liens>Liens <img src=https://blog.ogenki.io/icons/caret-icon.svg alt=icon class=nav_icon></a><div class=nav_sub><span class=nav_child></span>
<a href=https://www.linkedin.com/in/sma%C3%AFne-kahlouch-44374110/ class="nav_child nav_item" title=LinkedIn>LinkedIn</a></div></div><div class=nav_parent><a href=# class=nav_item>🌐</a><div class=nav_sub><span class=nav_child></span>
<a href=https://blog.ogenki.io/ class="nav_child nav_item">English</a>
<a href=https://blog.ogenki.io/fr/ class="nav_child nav_item">Français</a></div></div><div class=follow><a href=https://github.com/Smana><svg class="icon"><title>github</title><use xlink:href="#github"/></svg>
</a><a href=https://bsky.app/profile/smana.dev><svg class="icon"><title>bluesky</title><use xlink:href="#bluesky"/></svg>
</a><a href=https://www.linkedin.com/in/sma%C3%AFne-kahlouch-44374110/><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title><code>Dagger</code>: la pièce manquante de l'expérience développeur?</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg>
</span><span class=post_date>12-07-2024</span>
<span class=post_time>· 20 mins de lecture</span><span>&nbsp;· <a href=https://blog.ogenki.io/fr/tags/devxp/ title=devxp class="post_tag button button_translucent">devxp
</a></span><span class=page_only>&nbsp;·<div class=post_share>Partager sur:
<a href="https://twitter.com/intent/tweet?text=%60Dagger%60%3a%20la%20pi%c3%a8ce%20manquante%20de%20l%27exp%c3%a9rience%20d%c3%a9veloppeur%3f&url=https%3a%2f%2fblog.ogenki.io%2ffr%2fpost%2fdagger-intro%2f&tw_p=tweetbutton" class=twitter title="Partager sur Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg>
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.ogenki.io%2ffr%2fpost%2fdagger-intro%2f&t=%60Dagger%60%3a%20la%20pi%c3%a8ce%20manquante%20de%20l%27exp%c3%a9rience%20d%c3%a9veloppeur%3f" class=facebook title="Partager sur Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg>
</a><a href=#linkedinshare id=linkedinshare class=linkedin title="Partager sur LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg>
</a><a href=https://blog.ogenki.io/fr/post/dagger-intro/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_toc><h2>Sommaire</h2><nav id=TableOfContents><ul><li><a href=#-notre-objectif>🎯 Notre objectif</a></li><li><a href=#-la-découverte>🔎 La découverte</a></li><li><a href=#-daggeriser-une-application-existante>🦋 Daggeriser une application existante</a><ul><li><a href=#première-fonction->Première fonction 👶</a></li><li><a href=#et-mon-docker-compose-alors->Et mon docker-compose alors? 🐳</a></li></ul></li><li><a href=#-le-module-kubeconform>🧩 Le module Kubeconform</a></li><li><a href=#-itération-rapide-et-collaboration-grâce-à-un-cache-partagé>🚀 Itération rapide et collaboration grâce à un cache partagé</a><ul><li><a href=#-github-self-hosted-runners-accès-au-cache>🤖 Github Self Hosted Runners: Accès au cache</a></li><li><a href=#-considération-spécifiques-à-eks>☸️ Considération spécifiques à EKS</a></li></ul></li><li><a href=#-dernières-remarques>💭 Dernières remarques</a></li><li><a href=#-references>🔖 References</a></li></ul></nav></div><div class=post_body><p><a href=https://dagger.io/>Dagger</a> est un projet open source qui promet de révolutionner la façon de définir les pipelines d'<strong>intégration continue (CI)</strong>. Il a été créé par les fondateurs de Docker qui se sont basés sur une étude des difficultés courantes dans les entreprises. Il ont alors identifié un manque d'outillage efficaces le long du cycle de développement jusqu'au passage en production.</p><p>Il y a notamment un manque d'<strong>homogénéité entre les environnements d'exécution</strong>, vous avez probablement déjà entendu votre voisin(e) se plaindre avec un truc du genre: "Erf, ça marchait bien sur ma machine! C'est quoi cette erreur sur la CI?" 😆</p><p>Offrant une méthode commune et centralisée, Dagger serait LA réponse à cette problématique et permettrait, par ailleurs, d'améliorer l'expérience développeur locale, la collaboration et ainsi d'accélerer le cycle de développement.</p><center><img src=dagger-overview.png width=600 alt></center><p>Beaucoup d'entre nous ont déjà utilisé des scripts bash, des Makefiles et d'autres méthodes traditionnelles pour automatiser certaines actions. Cependant, ces solutions peuvent vite devenir <strong>complexes et difficiles à maintenir</strong>. Dagger propose une alternative moderne et simplifiée, permettant de standardiser et d'uniformiser nos pipelines, peu importe l'environnement.</p><p>Mais alors, quelles sont les principales fonctionnalités de Dagger, et comment l'utiliser efficacement?</p><h2 id=-notre-objectif>🎯 Notre objectif</h2><p>Voici les points que nous allons aborder dans cet article :</p><ol><li><p>Tout d'abord, nous allons comprendre le fonctionnement de <code>Dagger</code> et faire nos premiers pas.</p></li><li><p>Ensuite, nous prendrons des cas concrets pour sa mise en œuvre. Nous verrons comment transformer un projet existant, et je vous présenterai également un module que j'utilise désormais quotidiennement.</p></li><li><p>Enfin, nous décrirons une solution de mise en cache efficace, qui nous permettra de nous projeter dans la mise à l'échelle avec Dagger.</p></li></ol><h2 id=-la-découverte>🔎 La découverte</h2><p>En gros, <code>Dagger</code> est un outil qui nous permet de définir des tâches dans notre <strong>langage préféré</strong> et de rendre ce code <strong>portable</strong>. Autrement dit, ce que j'exécute sur ma machine sera exécuté de la même manière sur la CI ou sur l'ordinateur de mon/ma collègue.</p><p>Il y a 2 composants principaux qui entrent en jeu</p><ul><li>La <strong>CLI Dagger</strong>: Notre point d'accès principal pour interagir avec les différentes fonctions et modules, les télécharger et afficher le résultat de leur exécution.</li><li>Le <strong>moteur Dagger</strong>: Toutes les opérations effectuées avec la CLI passent par une API <code>GraphQL</code> exposée par un moteur Dagger. Chaque client initie sa propre session avec l'API Core qui dispose des fonctionnalités de base. Elles peuvent ensuite être étendues grâce à des modules.</li></ul><center><img src=dagger-api.png width=600 alt></center><p>Commençons par installer la CLI. Si vous avez parcouru mes précédents articles, vous savez que j'affectionne particulièrement <a href=https://blog.ogenki.io/fr/post/asdf/asdf/><strong>asdf</strong></a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>asdf plugin-add dagger
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=err></span><span class=go>asdf install dagger 0.12.1
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>Downloading dagger from https://github.com/dagger/dagger/releases/download/v0.12.1/dagger_v0.12.1_linux_amd64.tar.gz
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=err></span><span class=go>asdf global dagger 0.12.1
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>dagger version
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>dagger v0.12.1 (registry.dagger.io/engine) linux/amd64
</span></span></span></code></pre></div><p>Entrons dans le vif du sujet, nous pouvons tout de suite exécuter un module fournie par la communauté. Supposons que l'on veuille scanner un repo git et une image Docker avec <a href=https://aquasecurity.github.io/trivy/v0.53/>trivy</a>.</p><div class="notices info"><div class=label>Le Daggerverse</div><p>Le <a href=https://daggerverse.dev/><strong>Daggerverse</strong></a> est une plateforme permettant a quiconque de <strong>partager</strong> des modules. Lorsque vous avez un besoin, il est conseillé de regarder ce qui est déjà proposé par d'autres.</br>Faites le test en recherchant par example <code>golangci</code>, <code>black</code>, <code>gptscript</code>, <code>wolfi</code>...</p><center><img src=daggerverse.png width=1300 alt></center></div><p>Nous pouvons consulter les <strong>fonctions disponibles</strong> dans le module en utilisant l'argument <code>functions</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>TRIVY_MODULE=&#34;github.com/purpleclay/daggerverse/trivy@c3f44e0c8a396b2adf024bb862714037ae4cc8e7&#34;
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=err></span><span class=go>dagger functions -m ${TRIVY_MODULE}
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>Name          Description
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>filesystem    Scan a filesystem for any vulnerabilities
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>image         Scan a published (or remote) image for any vulnerabilities
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>image-local   Scan a locally exported image for any vulnerabilities
</span></span></span></code></pre></div><p>Les functions peuvent aussi prendre divers paramètres</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>dagger call -m ${TRIVY_MODULE} filesystem --help
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>...
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>ARGUMENTS
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>      --dir Directory      the path to directory to scan [required]
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>      --exit-code int      the returned exit code when vulnerabilities are detected (0)
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>      --format string      the type of format to use when generating the compliance report (table)
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>      --ignore-unfixed     filter out any vulnerabilities without a known fix
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>      --scanners string    the types of scanner to execute (vuln,secret)
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>      --severity string    the severity of security issues to detect (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>      --template string    a custom go template to use when generating the compliance report
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>      --vuln-type string   the types of vulnerabilities to scan for (os,library)
</span></span></span></code></pre></div><p>Analysons donc le niveau de sécurité de mon repository local 🕵️</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>dagger call -m ${TRIVY_MODULE} filesystem --dir &#34;.&#34;
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err></span><span class=go>scan/go.mod (gomod)
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>===================
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 1, HIGH: 0, CRITICAL: 0)
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=err></span><span class=go>┌────────────────────────────────┬────────────────┬──────────┬────────┬───────────────────┬───────────────┬───────────────────────────────────────────────────┐
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>│            Library             │ Vulnerability  │ Severity │ Status │ Installed Version │ Fixed Version │                       Title                       │
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>├────────────────────────────────┼────────────────┼──────────┼────────┼───────────────────┼───────────────┼───────────────────────────────────────────────────┤
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>│ github.com/vektah/gqlparser/v2 │ CVE-2023-49559 │ MEDIUM   │ fixed  │ 2.5.11            │ 2.5.14        │ gqlparser denial of service vulnerability via the │
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>│                                │                │          │        │                   │               │ parserDirectives function                         │
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go>│                                │                │          │        │                   │               │ https://avd.aquasec.com/nvd/cve-2023-49559        │
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>└────────────────────────────────┴────────────────┴──────────┴────────┴───────────────────┴───────────────┴───────────────────────────────────────────────────┘
</span></span></span></code></pre></div><p>Oups! il semble qu'il y ait une vulnérabilité critique dans mon image 😨.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>dagger call -m ${TRIVY_MODULE} image --ref smana/dagger-cli:v0.12.1 --severity CRITICAL
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err></span><span class=go>smana/dagger-cli:v0.12.1 (ubuntu 23.04)
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>=======================================
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>Total: 0 (CRITICAL: 0)
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=err></span><span class=go>usr/local/bin/dagger (gobinary)
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>===============================
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Total: 1 (CRITICAL: 1)
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=go>┌─────────┬────────────────┬──────────┬────────┬───────────────────┬─────────────────┬────────────────────────────────────────────────────────────┐
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>│ Library │ Vulnerability  │ Severity │ Status │ Installed Version │  Fixed Version  │                           Title                            │
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>├─────────┼────────────────┼──────────┼────────┼───────────────────┼─────────────────┼────────────────────────────────────────────────────────────┤
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>│ stdlib  │ CVE-2024-24790 │ CRITICAL │ fixed  │ 1.22.3            │ 1.21.11, 1.22.4 │ golang: net/netip: Unexpected behavior from Is methods for │
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>│         │                │          │        │                   │                 │ IPv4-mapped IPv6 addresses                                 │
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>│         │                │          │        │                   │                 │ https://avd.aquasec.com/nvd/cve-2024-24790                 │
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=go>└─────────┴────────────────┴──────────┴────────┴───────────────────┴─────────────────┴────────────────────────────────────────────────────────────┘
</span></span></span></code></pre></div><p>C'est déjà super cool de pouvoir bénéficier de nombreuses sources 🤩 ! Ces modules peuvent donc être utilisés directement ou devenir une source d'inspiration précieuse pour nos futurs pipelines.</p><p>Un <code>module</code> est une <strong>collection de fonctions</strong> qui prend des paramètres en entrée et nous renvoie une réponse sous différentes formes : du texte en sortie, l'exécution d'un terminal, le lancement d'un service, etc. Notons aussi que toutes les fonctions sont <strong>exécutées dans des conteneurs</strong>.</p><p>Après cette courte intro, passons à des cas d'usage réels en commençant par ajouter des tâches/fonctions à un projet existant.</p><h2 id=-daggeriser-une-application-existante>🦋 Daggeriser une application existante</h2><table><tr><td><img src=https://media.giphy.com/media/CWx3Qijmkf4746TtGu/giphy.gif style=width:100%></td><td style=vertical-align:middle;padding-left:20px width=60%>Prenons un <strong><a href=https://github.com/Smana/golang-helloworld>projet de démonstration</a></strong> existant, un simple serveur web avec une fonction de stockage de mots dans une base de données. Nous allons progressivement transformer ce projet en y <strong>injectant du Dagger</strong> 💉.</br>Cette approche itérative, étape par étape, peut également être appliquée à des projets plus importants pour les Daggeriser progressivement.</td></tr></table><h3 id=première-fonction->Première fonction 👶</h3><p>Notre priorité va être de <strong>tester</strong> le code en utilisant la commande <code>go test</code>.</p><p>Commençons donc par initialiser le repo git afin de générer l'arborescence requise pour l'exécution des fonctions Dagger.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>git clone https://github.com/Smana/golang-helloworld.git
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>cd golang-helloworld
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>dagger init --sdk=go
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>ls -l dagger*
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>.rw-r--r-- 101 smana 28 Jun 21:54 dagger.json
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=err></span><span class=go>dagger:
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>.rw-------  25k smana 28 Jun 21:54 dagger.gen.go
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>drwxr-xr-x    - smana 28 Jun 21:54 internal
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>.rw------- 1.4k smana 28 Jun 21:54 main.go
</span></span></span></code></pre></div><p>La commande d'initialisation génère donc un fichier <code>main.go</code> qui contient des fonctions d'exemple que nous allons totalement <strong>remplacer</strong> par le code suivant:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=kd>type</span> <span class=nx>GolangHelloworld</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1>// Test runs the tests for the GolangHelloworld project
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>GolangHelloworld</span><span class=p>)</span> <span class=nf>Test</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>source</span> <span class=o>*</span><span class=nx>Directory</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=nx>ctr</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Container</span><span class=p>().</span><span class=nf>From</span><span class=p>(</span><span class=s>&#34;golang:1.22&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>	<span class=k>return</span> <span class=nx>ctr</span><span class=p>.</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=nf>WithWorkdir</span><span class=p>(</span><span class=s>&#34;/src&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>		<span class=nf>WithMountedDirectory</span><span class=p>(</span><span class=s>&#34;/src&#34;</span><span class=p>,</span> <span class=nx>source</span><span class=p>).</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>		<span class=nf>WithExec</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;go&#34;</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=s>&#34;./...&#34;</span><span class=p>}).</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>		<span class=nf>Stdout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Il s'agit là d'une fonction très simple:</p><ul><li>Cette fonction, appelée <code>Test</code>, prend en paramètre un répertoire <code>source</code>.</li><li>Nous utilisons une image <code>golang:1.22</code>.</li><li>Le code du répertoire donné en paramètre est monté dans le dossier <code>/src</code> du conteneur.</li><li>Ensuite, nous exécutons la commande <code>go test ./...</code> sur le répertoire source.</li><li>Enfin, nous récupérons le résultat des tests (stdout).</li></ul><div class="notices note"><div class=label>Mise à jour de l'environnement de dev</div><p>Il est régulièrement nécessaire de lancer la commande suivante afin de mettre à jour les fichiers Dagger (dépendances etc...)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger develop
</span></span></span></code></pre></div></div><p>C'est parti, testons notre code!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger call test --source &#34;.&#34;
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>?       helloworld/cmd/helloworld       [no test files]
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>?       helloworld/dagger       [no test files]
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>?       helloworld/dagger/internal/dagger       [no test files]
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>?       helloworld/dagger/internal/querybuilder [no test files]
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>?       helloworld/dagger/internal/telemetry    [no test files]
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>ok      helloworld/internal/server      0.004s
</span></span></span></code></pre></div><p>&#8505;&#xfe0f; La première exécution prend du temps car elle construit télécharge l'image et installe les dépendances Go, mais les exécutions suivantes sont beaucoup plus rapides. Nous aborderons le sujet de la mise en cache plus tard dans cet article.</p><h3 id=et-mon-docker-compose-alors->Et mon docker-compose alors? 🐳</h3><p>Le projet initial permet de lancer un environnement de <strong>test local</strong> en utilisant <a href=https://docs.docker.com/compose/>Docker Compose</a></p><p>La commande <code>docker-compose up --build</code> effectue plusieurs actions :</br>elle construit l'image Docker de l'application en se basant sur le Dockerfile local, puis lance deux conteneurs : un pour l'application et un pour la base de données. Elle permet également la communication entre ces deux conteneurs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>docker ps
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>CONTAINER ID   IMAGE                               COMMAND                  CREATED         STATUS         PORTS                                       NAMES
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>a1673d56f9c8   golang-helloworld-app               &#34;/app/main&#34;              3 seconds ago   Up 3 seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   golang-helloworld-app-1
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>bb3dee1305dc   postgres:16                         &#34;docker-entrypoint.s…&#34;   3 seconds ago   Up 3 seconds   0.0.0.0:5432-&gt;5432/tcp, :::5432-&gt;5432/tcp   golang-helloworld-database-1
</span></span></span></code></pre></div><p>Il est ensuite possible d'accéder à l'application et de stocker des mots dans la base de données.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>curl -X POST -d &#39;{&#34;word&#34;:&#34;foobar&#34;}&#39; -H &#34;Content-Type: application/json&#34; http://localhost:8080/store
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=err></span><span class=go>curl http://localhost:8080/list
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>[&#34;foobar&#34;]
</span></span></span></code></pre></div><p><strong>Comment réaliser la même chose avec Dagger?</strong></p><p>Tout d'abord nous allons construire l'image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// Build the Docker container
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>GolangHelloworld</span><span class=p>)</span> <span class=nf>Build</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>source</span> <span class=o>*</span><span class=nx>Directory</span><span class=p>)</span> <span class=o>*</span><span class=nx>Container</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=c1>// build the binary
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>	<span class=nx>builder</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Container</span><span class=p>().</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=nf>From</span><span class=p>(</span><span class=nx>golangImage</span><span class=p>).</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=nf>WithDirectory</span><span class=p>(</span><span class=s>&#34;/src&#34;</span><span class=p>,</span> <span class=nx>source</span><span class=p>).</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>		<span class=nf>WithWorkdir</span><span class=p>(</span><span class=s>&#34;/src&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=nf>WithEnvVariable</span><span class=p>(</span><span class=s>&#34;CGO_ENABLED&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>		<span class=nf>WithExec</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;go&#34;</span><span class=p>,</span> <span class=s>&#34;build&#34;</span><span class=p>,</span> <span class=s>&#34;-o&#34;</span><span class=p>,</span> <span class=s>&#34;helloworld&#34;</span><span class=p>,</span> <span class=s>&#34;cmd/helloworld/main.go&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=c1>// Create the target image with the binary
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>	<span class=nx>targetImage</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Container</span><span class=p>().</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=nf>From</span><span class=p>(</span><span class=nx>alpineImage</span><span class=p>).</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>		<span class=nf>WithFile</span><span class=p>(</span><span class=s>&#34;/bin/helloworld&#34;</span><span class=p>,</span> <span class=nx>builder</span><span class=p>.</span><span class=nf>File</span><span class=p>(</span><span class=s>&#34;/src/helloworld&#34;</span><span class=p>),</span> <span class=nx>ContainerWithFileOpts</span><span class=p>{</span><span class=nx>Permissions</span><span class=p>:</span> <span class=mo>0700</span><span class=p>,</span> <span class=nx>Owner</span><span class=p>:</span> <span class=s>&#34;nobody&#34;</span><span class=p>}).</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>		<span class=nf>WithUser</span><span class=p>(</span><span class=s>&#34;nobody:nobody&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>		<span class=nf>WithEntrypoint</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;/bin/helloworld&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl>	<span class=k>return</span> <span class=nx>targetImage</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Ce code démontre l'utilisation du <strong>"multi-stage build"</strong> pour optimiser la sécurité et la taille de l'image. Cette méthode permet de n'inclure que ce qui est nécessaire dans l'image finale, réduisant ainsi la surface d'attaque et la taille de l'image.</p><p>Ensuite nous avons besoin d'une instance <code>PostgreSQL</code>. Ça tombe bien il y a un <a href=https://daggerverse.dev/mod/github.com/quartz-technology/daggerverse/postgres@627fc4df7de8ce3bd8710fa08ea2db6cf16712b3>module</a> pour ça ®!</p><p>Nous allons donc installer cette dépendance pour pouvoir utiliser ses fonctions directement dans notre code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger install github.com/quartz-technology/daggerverse/postgres@v0.0.3
</span></span></span></code></pre></div><p>La fonction <code>Database()</code> permet de lancer un conteneur Postgres.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	<span class=nx>opts</span> <span class=o>:=</span> <span class=nx>PostgresOpts</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>		<span class=nx>DbName</span><span class=p>:</span>     <span class=nx>dbName</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>		<span class=nx>Cache</span><span class=p>:</span>      <span class=nx>cache</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=nx>Version</span><span class=p>:</span>    <span class=s>&#34;13&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=nx>ConfigFile</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>		<span class=nx>InitScript</span><span class=p>:</span> <span class=nx>initScriptDir</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=nx>pgCtr</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Postgres</span><span class=p>(</span><span class=nx>pgUser</span><span class=p>,</span> <span class=nx>pgPass</span><span class=p>,</span> <span class=nx>pgPortInt</span><span class=p>,</span> <span class=nx>opts</span><span class=p>).</span><span class=nf>Database</span><span class=p>()</span>
</span></span></code></pre></div><p>Ensuite, nous devons créer un lien entre les deux conteneurs. Ci-dessous, nous récupérons les informations du service exposé par le conteneur Postgres pour les utiliser dans notre application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	<span class=nx>pgSvc</span> <span class=o>:=</span> <span class=nx>pgCtr</span><span class=p>.</span><span class=nf>AsService</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=nx>pgHostname</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pgSvc</span><span class=p>.</span><span class=nf>Hostname</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not get postgres hostname: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	<span class=k>return</span> <span class=nx>ctr</span><span class=p>.</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>		<span class=nf>WithSecretVariable</span><span class=p>(</span><span class=s>&#34;PGPASSWORD&#34;</span><span class=p>,</span> <span class=nx>pgPass</span><span class=p>).</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>		<span class=nf>WithSecretVariable</span><span class=p>(</span><span class=s>&#34;PGUSER&#34;</span><span class=p>,</span> <span class=nx>pgUser</span><span class=p>).</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>		<span class=nf>WithEnvVariable</span><span class=p>(</span><span class=s>&#34;PGHOST&#34;</span><span class=p>,</span> <span class=nx>pgHostname</span><span class=p>).</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=nf>WithEnvVariable</span><span class=p>(</span><span class=s>&#34;PGDATABASE&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>DbName</span><span class=p>).</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>		<span class=nf>WithEnvVariable</span><span class=p>(</span><span class=s>&#34;PGPORT&#34;</span><span class=p>,</span> <span class=nx>pgPort</span><span class=p>).</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>		<span class=nf>WithServiceBinding</span><span class=p>(</span><span class=s>&#34;database&#34;</span><span class=p>,</span> <span class=nx>pgSvc</span><span class=p>).</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>		<span class=nf>WithExposedPort</span><span class=p>(</span><span class=mi>8080</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=o>...</span>
</span></span></code></pre></div><div class="notices info"><div class=label>Les secrets 🔒</div><p>Les informations sensibles peuvent être passées lors de l'appel aux fonctions Dagger de plusieurs façon: Des <strong>variables d'environnement</strong>, lecture du contenu de <strong>fichiers</strong> ou la sortie d'une <strong>ligne de commande</strong>.
Dans cet article nous avons privilégié les variables d'environnement mais nous aurions très bien pu utiliser une commande <code>vault</code>. (<a href=https://blog.ogenki.io/fr/post/pki-gapi/>Article précédent sur Vault</a>)</p></div><p><code>up</code> permet de transférer les appels locaux aux services exposés par le conteneur.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>export PGUSER=&#34;user&#34;
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>export PGPASS=&#34;password&#34;
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>dagger call serve --pg-user=env:PGUSER --pg-pass=env:PGPASS --source &#34;.&#34;  as-service up
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=err></span><span class=go>...
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>  ● start /bin/helloworld 30.7s
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>  ┃ 2024/06/30 08:27:50 Starting server on :8080
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>  ┃ 2024/06/30 08:27:50 Starting server on :8080
</span></span></span></code></pre></div><p>Et voilà! nous pouvons désormais tester notre application en local.</br></p><div class="notices tip"><div class=label>D'autres fonctions</div><p>J'ai volontairement tronqué ces derniers extraits, mais je vous invite à consulter la configuration complète <a href=https://github.com/Smana/golang-helloworld/blob/daggerize/dagger/main.go><strong>ici</strong></a>. Vous y trouverez notamment la possibilité de publier l'image dans un registry.</p><p>De plus, je vous conseille de parcourir le <a href=https://docs.dagger.io/cookbook><strong>Cookbook</strong></a> dans la documentation Dagger, où vous trouverez de nombreux exemples.</p></div><h2 id=-le-module-kubeconform>🧩 Le module Kubeconform</h2><p>Je suis parti d'un <strong>réel cas d'usage</strong>: J'utilise depuis quelques années un <a href=https://github.com/fluxcd/flux2-kustomize-helm-example/blob/main/scripts/validate.sh>script bash</a> pour valider les manifests Kubernetes/Kustomize ainsi que la configuration <a href=https://fluxcd.io/>Flux</a>.
L'idée est donc de répondre à ce même besoin mais aussi d'aller un peu plus loin...</p><p>L'initialisation d'un module se fait de la façon suivante:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger init --name=kubeconform --sdk=go kubeconform
</span></span></span></code></pre></div><p>Il faut ensuite décider des paramètres d'entrée. Par exemple je souhaite pouvoir choisir la version du binaire <a href=https://github.com/yannh/kubeconform>Kubeconform</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln>1</span><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>	<span class=c1>// Kubeconform version to use for validation.
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1></span>	<span class=c1>// +optional
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1></span>	<span class=c1>// +default=&#34;v0.6.6&#34;
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=c1></span>	<span class=nx>version</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=o>...</span>
</span></span></code></pre></div><p>Les commentaires ci-dessus sont importants: La description sera affichée à l'utilisateur et nous pouvons faire en sorte que ce paramètre ne soit pas requis avec une version par défault.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger call -m github.com/Smana/daggerverse/kubeconform@v0.1.0 validate --help
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>Validate the Kubernetes manifests in the provided directory and optional source CRDs directories
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>...
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>      --version string        Kubeconform version to use for validation. (default &#34;v0.6.6&#34;)
</span></span></span></code></pre></div><p>L'objectif est de pouvoir partager ce module, donc tous les éléments de contexte doivent être clairs et compréhensibles.</p><p>En développant ce module, j'ai suis passé par plusieurs itérations et j'ai obtenu des infos très utiles sur le <a href=https://discord.com/invite/ufnyBtc8uY>Discord</a> de Dagger. C'est un super moyen d'échanger avec la communauté.</p><p>Analysons par exemple ceci:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=nx>kubeconformBin</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Arc</span><span class=p>().</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nf>Unarchive</span><span class=p>(</span><span class=nx>dag</span><span class=p>.</span><span class=nf>HTTP</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;https://github.com/yannh/kubeconform/releases/download/%s/kubeconform-linux-amd64.tar.gz&#34;</span><span class=p>,</span> <span class=nx>kubeconform_version</span><span class=p>)).</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>        <span class=nf>WithName</span><span class=p>(</span><span class=s>&#34;kubeconform-linux-amd64.tar.gz&#34;</span><span class=p>)).</span><span class=nf>File</span><span class=p>(</span><span class=s>&#34;kubeconform-linux-amd64/kubeconform&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>J'utilise le module <a href=https://daggerverse.dev/mod/github.com/sagikazarmark/daggerverse/arc@b45dbd7448bb967aca4a538af9ce7f042abf0316>Arc</a> pour décompresser un fichier récupéré avec la fonction <code>HTTP</code> et je ne prends que le binaire inclus dans cette archive. Plutôt efficace !</p><p>Dans cet autre exemple j'utilise le module <a href=https://daggerverse.dev/mod/github.com/vito/daggerverse/apko@09c1b5b172e58a8fd58ee790d81018cd478590fc>Apko</a> pour construire l'image initial, y installer des packages...</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=nx>ctr</span> <span class=o>:=</span> <span class=nx>dag</span><span class=p>.</span><span class=nf>Apko</span><span class=p>().</span><span class=nf>Wolfi</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;bash&#34;</span><span class=p>,</span> <span class=s>&#34;curl&#34;</span><span class=p>,</span> <span class=s>&#34;kustomize&#34;</span><span class=p>,</span> <span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;python3&#34;</span><span class=p>,</span> <span class=s>&#34;py3-pip&#34;</span><span class=p>,</span> <span class=s>&#34;yq&#34;</span><span class=p>}).</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nf>WithExec</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;pip&#34;</span><span class=p>,</span> <span class=s>&#34;install&#34;</span><span class=p>,</span> <span class=s>&#34;pyyaml&#34;</span><span class=p>})</span>
</span></span></code></pre></div><p>Au moment où j'écris cet article, le module Kubeconform inclut aussi un bout de script bash, essentiellement pour parcourir l'arborescence efficacement et exécuter <code>kubeconform</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl>	<span class=nx>scriptContent</span> <span class=o>:=</span> <span class=s>`#!/bin/bash
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=s>...
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=s>`</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	<span class=c1>// Add the manifests and the script to the container
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>	<span class=nx>ctr</span> <span class=p>=</span> <span class=nx>ctr</span><span class=p>.</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>		<span class=nf>WithMountedDirectory</span><span class=p>(</span><span class=s>&#34;/work&#34;</span><span class=p>,</span> <span class=nx>manifests</span><span class=p>).</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=nf>WithNewFile</span><span class=p>(</span><span class=s>&#34;/work/run_kubeconform.sh&#34;</span><span class=p>,</span> <span class=nx>ContainerWithNewFileOpts</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>			<span class=nx>Permissions</span><span class=p>:</span> <span class=mo>0750</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>			<span class=nx>Contents</span><span class=p>:</span>    <span class=nx>scriptContent</span><span class=p>,</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>	<span class=c1>// Execute the script
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1></span>	<span class=nx>kubeconform_command</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;bash&#34;</span><span class=p>,</span> <span class=s>&#34;/work/run_kubeconform.sh&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=o>...</span>
</span></span></code></pre></div><p>Pour tester et corriger le module nous pouvons l'exécuter localement sur un repo qui contient des manifests Kubernetes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>dagger call validate --manifests ~/Sources/demo-cloud-native-ref/clusters --catalog
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>...
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>Summary: 1 resource found in 1 file - Valid: 1, Invalid: 0, Errors: 0, Skipped: 0
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>Validation successful for ./mycluster-0/crds.yaml
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>Processing file: ./mycluster-0/flux-config.yaml
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>Summary: 1 resource found in 1 file - Valid: 1, Invalid: 0, Errors: 0, Skipped: 0
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>Validation successful for ./mycluster-0/flux-config.yaml
</span></span></span></code></pre></div><p>Nous pouvons aussi augmenter le niveau de verbosité. Le niveau le plus élevé étant <code>-vvv --debug</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>dagger call validate --manifests ~/Sources/demo-cloud-native-ref/clusters --catalog -vvv --debug
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>...
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>09:32:07 DBG new end old=&#34;2024-07-06 09:32:07.436103097 +0200 CEST&#34; new=&#34;2024-07-06 09:32:07.436103273 +0200 CEST&#34;
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>09:32:07 DBG recording span span=telemetry.LogsSource/Subscribe id=b3fc48ec7900f581
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>09:32:07 DBG recording span child span=telemetry.LogsSource/Subscribe parent=ae535768bb2be9d7 child=b3fc48ec7900f581
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>09:32:07 DBG new end old=&#34;2024-07-06 09:32:07.436103273 +0200 CEST&#34; new=&#34;2024-07-06 09:32:07.438699251 +0200 CEST&#34;
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>09:32:07 DBG recording span span=&#34;/home/smana/.asdf/installs/dagger/0.12.1/bin/dagger call -m github.com/Smana/daggerverse/kubeconform@v0.1.0 validate --manifests /home/smana/Sources/demo-cloud-native-ref/clusters --catalog -vvv --debug&#34; id=ae535768bb2be9d7
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>09:32:07 DBG frontend exporting logs logs=4
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>09:32:07 DBG exporting log span=0xf62760 body=&#34;&#34;
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>09:32:07 DBG got EOF
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>09:32:07 DBG run finished err=&lt;nil&gt;
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=err></span><span class=go>✔ 609fcdee60c94c07 connect 0.6s
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>  ✔ c873c2d69d2b7ce7 starting engine 0.5s
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>    ✔ 5f48c41bd0a948ca create 0.5s
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>      ✔ dbd62c92c3db105f exec docker start dagger-engine-ceb38152f96f1298 0.0s
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>      ┃ dagger-engine-ceb38152f96f1298
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=go>  ✔ 4db8303f1d7ec940 connecting to engine 0.1s
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=go>  ┃ 09:32:03 DBG connecting runner=docker-image://registry.dagger.io/engine:v0.12.1 client=5fa0kn1nc4qlku1erer3868nj
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=go>  ┃ 09:32:03 DBG subscribing to telemetry remote=docker-image://registry.dagger.io/engine:v0.12.1
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=go>  ┃ 09:32:03 DBG subscribed to telemetry elapsed=19.095µs
</span></span></span></code></pre></div><p>À partir de la version v0.12.x, Dagger propose un mode <strong>interactif</strong>. En utilisant le paramètre <code>-i</code> ou <code>--interactive</code>, il est possible de lancer automatiquement un terminal lorsque le code rencontre une erreur. Cela permet de réaliser des vérifications et des opérations directement dans le conteneur.</p><p>De plus, il est possible d'ajouter l'exécution de <code>Terminal()</code> à n'importe quel endroit dans la définition du conteneur pour entrer en mode interactif à ce moment précis.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln>1</span><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>	<span class=nx>stdout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctr</span><span class=p>.</span><span class=nf>WithExec</span><span class=p>(</span><span class=nx>kubeconform_command</span><span class=p>).</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>		<span class=nf>Terminal</span><span class=p>().</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>		<span class=nf>Stdout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=o>...</span>
</span></span></code></pre></div><p>Avec ce module j'ai pu ajouter aussi des fonctionnalités manquantes qui sont fort utiles:</p><ul><li>Convertir toutes les CRDs en JSONSchemas afin de valider 100% des manifests Kubernetes</li><li>Le rendre compatible avec les substitutions de variables de Flux.</li></ul><p>Enfin, j'ai pu le partager dans le <a href=https://daggerverse.dev/mod/github.com/Smana/daggerverse/kubeconform@3291d9cd86b8421fdff3bc7fafd9ca73be4c6060>Daggerverse</a> et mettre à jour mes workflows de CI sur Github Actions.</p><center><img src=github-actions-output.png width=1200 alt></center><h2 id=-itération-rapide-et-collaboration-grâce-à-un-cache-partagé>🚀 Itération rapide et collaboration grâce à un cache partagé</h2><p>Utiliser un cache permet de ne pas réexécuter les étapes dont le code n'a pas changé. Lors de la première exécution, toutes les étapes seront exécutées, mais les suivantes ne reprendront que les étapes modifiées, ce qui permet de <strong>gagner un temps considérable</strong>.</p><p>Dagger permet de mettre en cache, à <strong>chaque exécution</strong>, les opérations de manipulation des fichiers, la construction des conteneurs, l'exécution des tests, la compilation du code, ainsi que les volumes qui doivent être explicitement définis dans le code.</p><p>Par défaut, le moteur Dagger est disponible en local, et utilise du cache local.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>docker ps
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>CONTAINER ID   IMAGE                               COMMAND                  CREATED      STATUS       PORTS     NAMES
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>3cec5bf51843   registry.dagger.io/engine:v0.12.1   &#34;dagger-entrypoint.s…&#34;   8 days ago   Up 2 hours             dagger-engine-ceb38152f96f1298
</span></span></span></code></pre></div><p>La proposition suivante vise à définir un <strong>cache partagé et distant</strong>, accessible à tous les collaborateurs ainsi que depuis la CI. L'objectif est d'<strong>accélérer</strong> les exécutions ultérieures, peu importe où Dagger est exécuté.</p><p>Nous allons voir comment mettre cela en pratique avec:</p><ul><li>Des Github Runners exécutés en privé, sur notre plateforme (Self-Hosted)</li><li>Un moteur Dagger centralisé</li></ul><div class="notices tip"><div class=label>Cloud Native Reference</div><table><tr><td><img src=repo_gift.png style=width:100%></td><td style=vertical-align:middle;padding-left:80px width=70%>Cette solution de <strong>CI sur EKS</strong> est déployée en utilisant le repository <strong><a href=https://github.com/Smana/demo-cloud-native-ref>Cloud Native Ref</a></strong>.</br>Je vous encourage vivement à le consulter, car j'y aborde de nombreux sujets relatifs aux technlogies Cloud Native. L'idée initial de ce projet est de pouvoir <strong>démarrer rapidement une plateforme</strong> qui applique les bonnes pratiques en terme d'automatisation, de supervision, de sécurité etc.
Les commentaires et contributions sont les bienvenues 🙏</td></tr></table></div><p>Voici comment les composants de CI interagissent, avec Dagger jouant un <strong>rôle central</strong> grâce au cache partagé.</p><center><img src=dagger-cache-kubernetes.png height=600 alt></center><p>Maintenant que nous avons une vue d'ensemble de Dagger et de son utilisation, nous allons explorer comment optimiser son utilisation en entreprise en utilisant un cache partagé.</p><h3 id=-github-self-hosted-runners-accès-au-cache>🤖 Github Self Hosted Runners: Accès au cache</h3><p>Dagger s'intègre bien avec la plupart des solutions de CI. Il suffit en effet de lancer une commande <code>dagger</code>. Dans cet article nous faisons usage de l'<a href=https://github.com/dagger/dagger-for-github>Action</a> pour Github Actions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=w>  </span><span class=nt>kubernetes-validation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Kubernetes validation ☸</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v4</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Validate Flux clusters manifests</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>dagger/dagger-for-github@v6</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>          </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>          </span><span class=nt>verb</span><span class=p>:</span><span class=w> </span><span class=l>call</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>          </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>github.com/Smana/daggerverse/kubeconform@kubeconform/v0.1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=l>validate --manifests &#34;./clusters&#34; --catalog</span><span class=w>
</span></span></span></code></pre></div><p>Ce job télécharge le code source du repo git et exécute le module <code>kubeconform</code>. Bien que cela fonctionne très bien, il faut noter que ce job est exécuté sur les runners fournis par Github sur leur infrastructure.</p><p>Les <a href=https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners>GitHub self-hosted runners</a> sont des machines que vous configurez pour exécuter des workflows GitHub Actions sur <strong>votre propre infrastructure</strong>, plutôt que d'utiliser les runners hébergés par GitHub. Ils offrent plus de contrôle et de flexibilité, permettant de <strong>personnaliser l'environnement d'exécution</strong> selon vos besoins spécifiques. Cela peut conduire à des <strong>performances</strong> améliorées et permet un accès sécurisé à des <strong>ressources privées</strong>.</p><p>Un <code>Scale set</code> est un group de runners Github qui partage une configuration commune:
<a href=https://github.com/Smana/demo-cloud-native-ref/blob/main/.github/workflows/ci.yaml>.github/workflows/ci.yaml</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>helm.toolkit.fluxcd.io/v2</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HelmRelease</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dagger-gha-runner-scale-set</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class=l>dagger-gha-runner-scale-set</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nt>runnerGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>githubConfigUrl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://github.com/Smana/demo-cloud-native-ref&#34;</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>githubConfigSecret</span><span class=p>:</span><span class=w> </span><span class=l>gha-runner-scale-set</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>maxRunners</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=nt>containerMode</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>15</span><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;dind&#34;</span><span class=w>
</span></span></span></code></pre></div><ul><li>Ce <code>scale set</code> est configuré pour le repo <a href=https://github.com/Smana/demo-cloud-native-ref>Cloud Native Ref</a></li><li>Il faut lui indiquer un secret dans lequel est configuré les paramètres de la <code>Github App</code></li><li><code>dind</code> indique le mode utilisé pour lancer les conteneurs. ⚠️ Attention cependant en termes de sécurité : Dagger doit s'exécuter en tant qu'<strong>utilisateur root</strong> et avoir des permissions élevées pour contrôler les conteneurs, volumes, réseaux, etc. (Plus d'informations <a href=https://github.com/dagger/dagger/blob/main/core/docs/d7yxc-operator_manual.md#can-i-run-the-dagger-engine-as-a-rootless-container>ici</a>).</li></ul><h3 id=-considération-spécifiques-à-eks>☸️ Considération spécifiques à EKS</h3><p>Il existe plusieurs approches lorsqu'il s'agit de l'optimisation du cache, chacune présentant des avantages et inconvénients. Cela fait d'ailleurs l'objet de discussions très intéressantes <a href=ttps://github.com/dagger/dagger/issues/6486>ici</a>.
J'ai fait quelques choix qui, selon moi, sont un bon compromis entre disponibilité et performances dont voici les principales lignes:</p><ul><li><p><strong>Le moteur Dagger</strong>: Un unique pod expose un service HTTP.</p></li><li><p><strong>NodePool spécifique</strong> : Un node pool avec des contraintes permettant d'obtenir des disques NVME locaux.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>karpenter.k8s.aws/instance-local-nvme</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Gt</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;100&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>karpenter.k8s.aws/instance-category</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;i&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;m&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;r&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>ogenki/io</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>Les points de montages des conteneurs</strong>: Lorsqu'un nœud du nodepool io démarre, il exécute la commande <code>/usr/bin/setup-local-disks raid0</code>. Cette commande prépare les disques en créant un array en <strong>raid0</strong> et monte les systèmes de fichiers des conteneurs dessus. Ainsi, tout cet espace est directement accessible depuis le pod !</p></li></ul><p>⚠️ Notez que c'est un <strong>volume éphémère</strong> : les données sont perdues lorsque le pod est arrêté. C'est cet espace que nous utilisons pour le <strong>cache</strong> Dagger.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdagger</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>          </span><span class=nt>ephemeral</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>            </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>              </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>                </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>                </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>                  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>                    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varrundagger</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>          </span><span class=nt>ephemeral</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>            </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>              </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>                </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>                </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>                  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>                    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>90Gi</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl exec -ti -n tooling dagger-engine-c746bd8b8-b2x6z -- /bin/sh
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>/ # df -h | grep nvme
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>/dev/nvme3n1              9.7G    128.0K      9.7G   0% /var/lib/dagger
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>/dev/nvme2n1             88.0G     24.0K     88.0G   0% /run/buildkit
</span></span></span></code></pre></div><ul><li><p><strong>Bonnes pratiques avec Karpenter</strong>: Afin d'optimiser la disponibilité du moteur Dagger, nous l'avons configuré avec un <a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets>Pod Disruption Budget</a> ainsi que l'annotation <code>karpenter.sh/do-not-disrupt: "true"</code>. Par ailleurs il est préférable d'utiliser des instances <code>On-demand</code>, que nous pourrions envisager de réserver auprès de AWS afin d'obtenir un discount.</p></li><li><p><strong>Network policies</strong>: Étant donné que les runners peuvent exécuter n'importe quel code, il est fortement recommandé de limiter les flux réseaux au strict nécessaire, que ce soit pour les self-hosted runners ou le moteur dagger.</p></li></ul><p>Afin de tester cela, nous allons lancer un job qui crée un conteneur en installer de nombreux paquets relativement lourds. L'idée etant que cela prenne en peu de temps.</p><p><a href=https://github.com/Smana/demo-cloud-native-ref/blob/main/.github/workflows/ci.yaml>.github/workflows/ci.yaml</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=w>  </span><span class=nt>test-cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Testing in-cluster cache</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>dagger-gha-runner-scale-set</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=nt>container</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>smana/dagger-cli:v0.12.1</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>      </span><span class=nt>_EXPERIMENTAL_DAGGER_RUNNER_HOST</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tcp://dagger-engine:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>      </span><span class=nt>cloud-token</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.DAGGER_CLOUD_TOKEN }}</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Simulate a build with heavy packages</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>dagger/dagger-for-github@v6</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>          </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>          </span><span class=nt>verb</span><span class=p>:</span><span class=w> </span><span class=l>call</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>          </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>github.com/shykes/daggerverse.git/wolfi@dfb1f91fa463b779021d65011f0060f7decda0ba</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=l>container --packages &#34;python3,py3-pip,go,rust,clang&#34;</span><span class=w>
</span></span></span></code></pre></div><p>ℹ️ Accéder au moteur Dagger distant se fait en utilisant la variable d'environnement <code>_EXPERIMENTAL_DAGGER_RUNNER_HOST</code></p><p>Lors de la première exécution, le job met <strong>3min et 37secs</strong></p><center><img src=cache_first_run.png height=600 alt></center><p>En revanche tout autre exécution ultérieure sera <strong>beaucoup plus rapide</strong> (10secs)! 🎉 🚀 🥳</p><center><img src=cache_second_run.png height=600 alt></center><p>En local 💻 , je peux aussi bénéficier de ce cache en configurant mon environnement comme cela:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl port-forward -n tooling svc/dagger-engine 8080
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>_EXPERIMENTAL_DAGGER_RUNNER_HOST=&#34;tcp://127.0.0.1:8080&#34;
</span></span></span></code></pre></div><p>Mes tests locaux seront aussi accessible par la CI et un autre développeur reprenant mon travail n'aura pas à tout reconstruire de zéro.</p><div class="notices note"><div class=label>Attention</div><p>➕ Cette solution a l'avantage non négigeable de disposer d'un stockage ulta <strong>rapide</strong>! De plus l'architecture est on ne peut plus simple: un seul moteur Dagger avec un stockage local qui expose un service.</p><p>➖ ⚠️ C'est pourtant loin d'être parfait: il faut, en effet accépter que ce cache soit <strong>éphémère</strong> malgré les précautions prises pour garantir un niveau de disponibilité élevé. Par ailleurs il faut aussi prendre en compte le <strong>coût</strong> d'une instance qui tourne tout le temps, le scaling ne peut se faire qu'en prenant une machine plus grosse.</p></div><div class="notices info"><div class=label>Dagger Cloud</div><table><tr><td style=vertical-align:middle;padding-left:80px width=60%><strong>Dagger Cloud</strong> est une solution pour les entreprises permettant une visualisation très claire de l'exécution des pipelines, avec la possibilité de parcourir toutes les étapes et d'identifier rapidement les éventuelles problèmes. C'est gratuit pour un usage individuel et je vous encourage à tester.</br>Cette offre fourni également une alternative à la solution proposée ci-dessus: un cache distribué, géré par Dagger. (Plus d'informations <a href=https://dagger.io/cloud>ici</a>)</td><td><img src=dagger-cloud.png style=width:100%></td></tr><tr><td colspan=2><video controls style=width:100%>
<source src=dagger-cloud.webm type=video/webm>Your browser does not support the video tag.</video></td></tr></table></div><h2 id=-dernières-remarques>💭 Dernières remarques</h2><p>Dagger est un projet assez récent qui <strong>évolue vite</strong>, soutenu par une communauté toujours plus grande et active. Les questions de scaling abordées dans cet article seront probablement améliorées dans le futur.</p><p>Pour les modules disponibles dans le Daggerverse, il est parfois difficile de juger leur <strong>qualité</strong>. Il n'y a pas de modules "validés" ou "officiels", il faut donc souvent en tester plusieurs, analyser le code et parfois en créer un soi-même.</p><p>Cet article vous a permis de découvrir Dagger et ses principales fonctions que j'ai utilisées. Mon expérience s'est limitée au SDK Golang, mais l'expérience devrait être similaire avec d'autres langages. Je découvre des choses nouvelles chaque jour. La prise en main initiale n'est pas évidente pour ceux qui, comme moi, ne développent pas quotidiennement, mais plus je l'utilise sur des cas concrets, plus je me sens à l'aise. J'ai même migré les quelques <a href=https://github.com/Smana/demo-cloud-native-ref/blob/main/.github/workflows/ci.yaml>jobs de mon repo</a> à 100% sur Dagger.</p><p>Je suis passé de Makefile à <a href=https://taskfile.dev/>Task</a> et j'espère maintenant aller plus loin avec Dagger. J'ai l'ambition de construire des pipelines plus complexes, comme la restauration et la <a href=https://github.com/Smana/demo-cloud-native-ref/issues/217>vérification d'un backup Vault</a> ou encore la <a href=https://github.com/Smana/demo-cloud-native-ref/issues/216>création et les tests d'un cluster EKS avant de le détruire</a>. Quoi qu'il en soit, Dagger fait maintenant partie de ma boîte à outils ! &#9989;</p><h2 id=-references>🔖 References</h2><ul><li><a href=https://docs.dagger.io>Doc</a></li><li><a href=https://discord.com/invite/ufnyBtc8uY>Discord</a></li><li><a href=https://www.youtube.com/@dagger-io>Youtube</a></li></ul></div><div class=post_comments></div><div class=post_i18n><h3 class=mb-0>Traductions:</h3><nav class=tags_nav><a href=https://blog.ogenki.io/post/dagger-intro/ class="post_tag button button_translucent">English</a></nav></div></article><aside class=sidebar><section class=sidebar_inner><br><div class=search><input type=search class="search_field form_field" placeholder=Rechercher... id=find autocomplete=off data-scope=post>
<label for=find class=search_label><svg class="icon"><title>search</title><use xlink:href="#search"/></svg></label><div class="search_results results"></div></div><div class=author_header><img src=https://blog.ogenki.io/images/smana.jpg alt="Smaine Kahlouch photo"><h2>Smaine Kahlouch</h2></div><div class=author_bio>Lead SRE/DevOps, Team leader, Open Source enthusiast.</div><a href=https://blog.ogenki.io/fr/about/ class="button mt-1" role=button title='Lire la suite…'>Lire la suite…</a><h2 class=mt-4>Billets en vedette</h2><ul><li><a href=https://blog.ogenki.io/fr/post/series/observability/alerts/ class=nav-link title="`VictoriaMetrics` : Des alertes efficaces, de la théorie à la pratique 🛠️"><code>VictoriaMetrics</code> : Des alertes efficaces, de la théorie à la pratique 🛠️</a></li><li><a href=https://blog.ogenki.io/fr/post/series/observability/metrics/ class=nav-link title="Une solution complète et performante pour gérer vos métriques avec les opérateurs `VictoriaMetrics` et `Grafana`!">Une solution complète et performante pour gérer vos métriques avec les opérateurs <code>VictoriaMetrics</code> et <code>Grafana</code>!</a></li><li><a href=https://blog.ogenki.io/fr/post/dagger-intro/ class=nav-link title="`Dagger`: la pièce manquante de l'expérience développeur?"><code>Dagger</code>: la pièce manquante de l'expérience développeur?</a></li><li><a href=https://blog.ogenki.io/fr/post/pki-gapi/ class=nav-link title="`TLS` avec Gateway API: Une gestion efficace et sécurisée des certificats publiques et privés"><code>TLS</code> avec Gateway API: Une gestion efficace et sécurisée des certificats publiques et privés</a></li><li><a href=https://blog.ogenki.io/fr/post/crossplane_composition_functions/ class=nav-link title="Aller plus loin avec `Crossplane`: Compositions et fonctions">Aller plus loin avec <code>Crossplane</code>: Compositions et fonctions</a></li></ul><h2 class=mt-4>Billets récents</h2><ul class=flex-column><li><a href=https://blog.ogenki.io/fr/post/tailscale/ class=nav-link title="Sécuriser le Cloud avec `Tailscale` : Mise en œuvre d'un VPN simplifiée">Sécuriser le Cloud avec <code>Tailscale</code> : Mise en œuvre d'un VPN simplifiée</a></li><li><a href=https://blog.ogenki.io/fr/post/cilium-gateway-api/ class=nav-link title="`Gateway API`: Remplacer mon Ingress Controller avec `Cilium`?"><code>Gateway API</code>: Remplacer mon Ingress Controller avec <code>Cilium</code>?</a></li><li><a href=https://blog.ogenki.io/fr/post/terraform-controller/ class=nav-link title="Appliquer les principes de GitOps à l'infrastructure: Introduction à `tf-controller`">Appliquer les principes de GitOps à l'infrastructure: Introduction à <code>tf-controller</code></a></li><li><a href=https://blog.ogenki.io/fr/post/cnpg/ class=nav-link title="`CloudNativePG`: et PostgreSQL devient facile sur Kubernetes"><code>CloudNativePG</code>: et PostgreSQL devient facile sur Kubernetes</a></li><li><a href=https://blog.ogenki.io/fr/post/devflux/ class=nav-link title="100% `GitOps` using Flux">100% <code>GitOps</code> using Flux</a></li><li><a href=https://blog.ogenki.io/fr/post/crossplane_k3d/ class=nav-link title="Mon cluster Kubernetes (GKE) avec `Crossplane`">Mon cluster Kubernetes (GKE) avec <code>Crossplane</code></a></li><li><a href=https://blog.ogenki.io/fr/post/asdf/asdf/ class=nav-link title="Gérer les versions d'outils avec `asdf`">Gérer les versions d'outils avec <code>asdf</code></a></li></ul><div><h2 class="mt-4 taxonomy" id=series-section>Séries</h2><nav class=tags_nav><a href=https://blog.ogenki.io/fr/series/observability/ class="post_tag button button_translucent" title=observability>OBSERVABILITY
<span class=button_tally>2</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=tags-section>Tags</h2><nav class=tags_nav><a href=https://blog.ogenki.io/fr/tags/infrastructure/ class="post_tag button button_translucent" title=infrastructure>INFRASTRUCTURE
<span class=button_tally>4</span>
</a><a href=https://blog.ogenki.io/fr/tags/devxp/ class="post_tag button button_translucent" title=devxp>DEVXP
<span class=button_tally>3</span>
</a><a href=https://blog.ogenki.io/fr/tags/gitops/ class="post_tag button button_translucent" title=gitops>GITOPS
<span class=button_tally>2</span>
</a><a href=https://blog.ogenki.io/fr/tags/kubernetes/ class="post_tag button button_translucent" title=kubernetes>KUBERNETES
<span class=button_tally>2</span>
</a><a href=https://blog.ogenki.io/fr/tags/network/ class="post_tag button button_translucent" title=network>NETWORK
<span class=button_tally>2</span>
</a><a href=https://blog.ogenki.io/fr/tags/observability/ class="post_tag button button_translucent" title=observability>OBSERVABILITY
<span class=button_tally>2</span>
</a><a href=https://blog.ogenki.io/fr/tags/security/ class="post_tag button button_translucent" title=security>SECURITY
<span class=button_tally>2</span>
</a><a href=https://blog.ogenki.io/fr/tags/data/ class="post_tag button button_translucent" title=data>DATA
<span class=button_tally>1</span>
</a><a href=https://blog.ogenki.io/fr/tags/index/ class="post_tag button button_translucent" title=index>INDEX
<span class=button_tally>1</span>
</a><a href=https://blog.ogenki.io/fr/tags/local/ class="post_tag button button_translucent" title=local>LOCAL
<span class=button_tally>1</span>
</a><a href=https://blog.ogenki.io/fr/tags/tooling/ class="post_tag button button_translucent" title=tooling>TOOLING
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon"><path fill="#fff" d="m15.054695 9.8859583c-.22611 1.1632697-2.02517 2.4363497-4.09138 2.6830797-1.0774504.12856-2.1382704.24673-3.2694704.19484-1.84996-.0848-3.30971-.44157-3.30971-.44157.0.1801.0111.35157.0333.51194.24051 1.82571 1.81034 1.93508 3.29737 1.98607 1.50088.0514 2.8373104-.37004 2.8373104-.37004l.0617 1.35686s-1.0498104.56374-2.9199404.66742c-1.03124.0567-2.3117-.0259-3.80308-.42069-3.23454998-.85613-3.79081998-4.304-3.87592998-7.8024197-.026-1.03871-.01-2.01815-.01-2.83732.0-3.57732 2.34385998-4.62587996 2.34385998-4.62587996 1.18184-.54277 3.20976-.77101 5.318-.7882499985409h.0518C9.8267646.01719834 11.856025.24547834 13.037775.78824834c0 0 2.34377 1.04855996 2.34377 4.62587996.0.0.0294 2.63937-.32687 4.47183"/><path fill="#000" d="m12.616925 5.6916583v4.3315297h-1.71607V5.8189683c0-.88624-.37289-1.33607-1.1187604-1.33607-.82467.0-1.23799.53361-1.23799 1.58875v2.30122h-1.70594v-2.30122c0-1.05514-.4134-1.58875-1.23808-1.58875-.74587.0-1.11876.44983-1.11876 1.33607v4.2042197h-1.71607V5.6916583c0-.88527.22541-1.58876.67817-2.10922.46689-.52047 1.07833-.78727 1.83735-.78727.87816.0 1.54317.33752 1.98288 1.01267l.42744.71655.42753-.71655c.43961-.67515 1.10463-1.01267 1.9828704-1.01267.75893.0 1.37037.2668 1.83735.78727.45268.52046.67808 1.22395.67808 2.10922"/></symbol></svg><footer class=footer><div class="footer_inner wrap pale"><img src=https://blog.ogenki.io/icons/footer.png class="icon icon_2 transparent" alt="Copyright © 2021–2023, Smana https://github.io/Smana"><p>Copyright&nbsp;<span class=year></span>&nbsp;COPYRIGHT © 2021–2023, SMANA HTTPS://GITHUB.IO/SMANA. Tous droits réservés</p><a class=to_top href=#documentTop><svg class="icon"><title>to-top</title><use xlink:href="#to-top"/></svg></a></div></footer><script type=text/javascript src=https://blog.ogenki.io/fr/js/bundle.ae629666f8c58d943212e88a5f947766206c1a1a51ff5eaf4ff5a9281342b8ecd6b2ccb43d0136116dac746a8a4d6fa8f57bd22af9acc4b0aa9714608d09e679.js integrity="sha512-rmKWZvjFjZQyEuiKX5R3ZiBsGhpR/16vT/WpKBNCuOzWssy0PQE2EW2sdGqKTW+o9XvSKvmsxLCqlxRgjQnmeQ==" crossorigin=anonymous></script><script src=https://blog.ogenki.io/js/search.min.73cb82d8f274395dd220d6594053cd3d3d8ac8c97d874b5142a60b9744f3704d765551e0ade104d5803c66b731f5a7a00ac2cff33c8c9090ff8100169a3e2574.js></script></body></html>